!include MUI2.nsh
# name the installer
OutFile "Checkout_InstallerV@Checkout_VERSION_MAJOR@.@Checkout_VERSION_MINOR@.@Checkout_VERSION_COMPLEMENT@@Checkout_VERSION_RELEASE@.exe"

SetCompressor /FINAL /SOLID lzma
SetCompressorDictSize 4
!define MUI_COMPONENTSPAGE_SMALLDESC ;No value

!insertmacro MUI_PAGE_COMPONENTS
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES

!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

InstallDir "$PROGRAMFILES64\Checkout"

; These are the programs that are needed by ACME Suite.
Section -Prerequisites
  SetOutPath $INSTDIR\Prerequisites

  MessageBox MB_YESNO "Install the Microsoft Visual C++ 2015 Redistribual (x64) - 14 ?" /SD IDYES IDNO endNetCF
    File "C:\Work\GitHub\redist\VC_redist.x64.exe"
    ExecWait "$INSTDIR\VC_redist.x64.exe"
  endNetCF:

SectionEnd

# default section start; every NSIS script has at least one section.
Section "Main Installer Section"

# First step remove all !! to avoid mixing version and clear view on install error
RMDir /r $INSTDIR

# define output path
SetOutPath $INSTDIR\bin

# specify file to go in output path
File "@CMAKE_BINARY_DIR@\bin\Checkout.exe"
File "@CMAKE_BINARY_DIR@\bin\CheckoutHttpServer.exe"
File "@CMAKE_BINARY_DIR@\bin\*.dll"
File "@CMAKE_BINARY_DIR@\bin\ffmpeg.exe"

File "@CMAKE_BINARY_DIR@\bin\QtWebEngineProcess.exe"
File "@CMAKE_BINARY_DIR@\bin\*.dll"

SetOutPath $INSTDIR\bin\resources
File "@CMAKE_BINARY_DIR@\bin\resources\*.pak"
File "@CMAKE_BINARY_DIR@\bin\resources\*.dat"

SetOutPath $INSTDIR\bin\styles
File "@CMAKE_BINARY_DIR@\bin\styles\*.dll"

SetOutPath $INSTDIR\bin\bearer
File "@CMAKE_BINARY_DIR@\bin\bearer\*.dll"

SetOutPath $INSTDIR\bin\iconengines
File "@CMAKE_BINARY_DIR@\bin\iconengines\*.dll"

SetOutPath $INSTDIR\bin\translations
File "@CMAKE_BINARY_DIR@\bin\translations\*.qm"

SetOutPath $INSTDIR\bin\qtwebengine_locales
File "@CMAKE_BINARY_DIR@\bin\translations\qtwebengine_locales\*.pak"


CreateDirectory $INSTDIR\bin\Cache
;File "@CMAKE_BINARY_DIR@\bin\*.manifest"

# define uninstaller name
WriteUninstaller $INSTDIR\uninstaller.exe

# default section end
SectionEnd

Section "Plugin Installer Section"

# define output path
SetOutPath $INSTDIR\bin\plugins
File "@CMAKE_BINARY_DIR@\bin\plugins\*.dll"

;SetOutPath $INSTDIR\bin\Release\accessible
;File "@CMAKE_BINARY_DIR@\bin\accessible\*.dll"

SetOutPath $INSTDIR\bin\platforms
File "@CMAKE_BINARY_DIR@\bin\platforms\*.dll"

SetOutPath $INSTDIR\bin\iconengines
File "@CMAKE_BINARY_DIR@\bin\iconengines\*.dll"

SetOutPath $INSTDIR\bin\imageformats
File "@CMAKE_BINARY_DIR@\bin\imageformats\*.dll"

#SetOutPath $INSTDIR\bin\sqldrivers
#File "@CMAKE_BINARY_DIR@\bin\sqldrivers\*.dll"



SectionEnd

# create a section to define what the uninstaller does.
# the section will always be named "Uninstall"
Section "Uninstall"

# Always delete uninstaller first
Delete $INSTDIR\uninstaller.exe
Delete "$INSTDIR\bin\Checkout.exe"
Delete "$INSTDIR\bin\CheckoutProcessServer.exe"
Delete "$INSTDIR\bin\CheckoutCore.dll"
Delete "$INSTDIR\bin\CheckoutGui.dll"
Delete "$INSTDIR\bin\CheckoutPluginManager.dll"
Delete "$INSTDIR\bin\CheckoutServer.dll"
Delete "$INSTDIR\bin\icudt52.dll"
Delete "$INSTDIR\bin\icuin52.dll"
Delete "$INSTDIR\bin\icuuc52.dll"
Delete "$INSTDIR\bin\opencv_ffmpeg300_64.dll"
Delete "$INSTDIR\bin\opencv_world300.dll"
Delete "$INSTDIR\bin\Qt5Core.dll"
Delete "$INSTDIR\bin\Qt5Gui.dll"
Delete "$INSTDIR\bin\Qt5Network.dll"
Delete "$INSTDIR\bin\Qt5OpenGL.dll"
Delete "$INSTDIR\bin\Qt5Sql.dll"
Delete "$INSTDIR\bin\Qt5Widgets.dll"
Delete "$INSTDIR\bin\Qt5Xml.dll"
Delete "$INSTDIR\bin\Qt5XmlPatterns.dll"
Delete "$INSTDIR\bin\Qt5Concurrent.dll"

Delete "$INSTDIR\bin\plugins\*.dll"

SectionEnd
